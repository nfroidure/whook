[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# @whook/graphql
> GraphQL implementation for Whook servers

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/whook/blob/main/packages/whook-graphql/LICENSE)


[//]: # (::contents:start)

Brings GraphQL to your [Whook](https://github.com/nfroidure/whook) server!

This module uses [Apollo](https://www.apollographql.com/) under the hood. Most of
its concepts (modules, plugins...) applies to it.

## Quick setup

Install the module and its dependencies in your project:

```sh
npm i @whook/graphql graphql-tag
```

Update the types (usually in `src/whook.d.ts`):

```diff
+import {
+   type WhookGraphQLEnv,
+   type WhookGraphQLConfig,
+} from '@whook/graphql';

// ...

declare module 'application-services' {

  export interface AppEnvVars
    extends BaseAppEnvVars,
      WhookBaseEnv,
      // (...)
+      WhookGraphQLEnv,
      WhookSwaggerUIEnv {}

  // (...)

  export interface AppConfig
    extends WhookBaseConfigs,
      // (...)
+      WhookGraphQLConfig,
      JWTServiceConfig {}

  // ...

}
```

Declare the plugin into your `src/index.ts` file:

```diff
+  import { gql } from 'graphql-tag';
+  import { type WhookGraphQLFragmentService } from '@whook/graphql';
  // (...)

+  // Add the Apollo Server configuration
+  $.register(constant('GRAPHQL_SERVER_OPTIONS', {
+    csrfPrevention: true,
+  }));

  // Setup your own whook plugins or avoid whook defaults by leaving it empty
  $.register(
    constant('WHOOK_PLUGINS', [
      ...WHOOK_DEFAULT_PLUGINS,
+      '@whook/graphql',
      '@whook/cors',
    ]),
  );

  // ...

+  // Declare the GraphQL schema fragments
+  const helloFragment: WhookGraphQLFragmentService = {
+    typeDefs: gql`
+      type Query {
+        hello: String
+      }
+      schema {
+        query: Query
+      }
+    `,
+    resolvers: {
+      Query: {
+        hello: () => 'Hello world!',
+      },
+    },
+  };
+
+  $.register(
+    constant('graphQLFragments', [
+      helloFragment,
+    ]),
+  );

  // (...)
```

The GraphQL fragments can be declared into separated services for more
readability, just create a service to gather them all (usually in
`src/services/graphQLFragments.ts`):

```ts
import { initializer } from 'knifecycle';

export default initializer(
  {
    name: 'graphQLFragments',
    type: 'service',
    inject: ['graphQLUserFragment', 'graphQLMessageFragment'],
    singleton: true,
  },
  async (services) => Object.keys(services).map((key) => services[key]),
);
```

See [this repository tests](./src/intex.test.ts) for more examples.

[//]: # (::contents:end)

# API
<a name="initGraphQL"></a>

## initGraphQL(services, ENV, [graphQLFragments]) â‡’ <code>Promise</code>
Initialize the GraphQL service

**Kind**: global function  
**Returns**: <code>Promise</code> - A promise of a GraphQL service  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services the server depends on |
| services.ENV | <code>Object</code> |  | The injected ENV value |
| [services.GRAPHQL_SERVER_OPTIONS] | <code>Object</code> \| <code>function</code> |  | The GraphQL options to pass to the server |
| ENV | <code>String</code> |  | The process environment |
| [graphQLFragments] | <code>String</code> |  | Fragments of GraphQL schemas/resolvers declaration |
| [services.log] | <code>function</code> | <code>noop</code> | A logging function |


# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/whook/blob/main/packages/whook-graphql/LICENSE)
