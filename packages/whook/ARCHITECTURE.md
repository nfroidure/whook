[//]: # ( )
[//]: # (This file is automatically generated by the `jsarch`)
[//]: # (module. Do not change it elsewhere, changes would)
[//]: # (be overriden.)
[//]: # ( )
# Architecture Notes

## Summary

1. [Main file](#1-main-file)
   1. [Process run](#11-process-run)
   2. [Process preparation](#12-process-preparation)
   3. [Server environment](#13-server-environment)
2. [Services initializers](#2-services-initializers)
   1. [Base URL](#21-base-url)
   2. [IP detection](#22-ip-detection)
   3. [the `PWD` constant](#23-the-`pwd`-constant)
   3. [Port detection](#23-port-detection)
   4. [the `resolve` service](#24-the-`resolve`-service)
   5. [the `importer` service](#25-the-`importer`-service)
   6. [the `exit` service](#26-the-`exit`-service)
   6. [the `WHOOK_PLUGINS` constant](#26-the-`whook_plugins`-constant)
   7. [the `logger` service](#27-the-`logger`-service)
      1. [Logging](#271-logging)
   8. [The `CONFIG` service](#28-the-`config`-service)
   9. [the `$autoload` service](#29-the-`$autoload`-service)
      1. [the `APP_CONFIG` mapper](#291-the-`app_config`-mapper)
      2. [the `API` auto loading](#292-the-`api`-auto-loading)
         1. [API definitions loader](#2921-api-definitions-loader)
         2. [Typings generator](#2922-typings-generator)
         3. [Open API generator](#2923-open-api-generator)
      3. [the `INITIALIZER_PATH_MAP` mapper](#293-the-`initializer_path_map`-mapper)
         1. [Initializer path mapping](#2931-initializer-path-mapping)
      4. [the `HANDLERS` mapper](#294-the-`handlers`-mapper)
      5. [the `WRAPPERS` auto loading](#295-the-`wrappers`-auto-loading)
      6. [Service/handler/wrapper loading](#296-service/handler/wrapper-loading)
         1. [Plugins resolution](#2961-plugins-resolution)
         2. [Plugins/project paths](#2962-plugins/project-paths)
3. [the handlers](#3-the-handlers)
   1. [Testing](#41-testing)


## 1. Main file

The Whook's main file exports :
- its specific types,
- its specific `knifecycle` compatible services,
- a few bootstrapping functions designed to be customizable.

[See in context](./src/index.ts#L200-L205)



### 1.1. Process run

Whook exposes a `runProcess` function to programmatically spawn
 its process. It is intended to be reusable and injectable so
 that projects can override the whole `whook` default behavior.

[See in context](./src/index.ts#L207-L211)



### 1.2. Process preparation

Whook exposes a `prepareProcess` function to create its
 configuration. It takes eventually additional injections that
 would be required at a higher level and a
 [Knifecycle](https://github.com/nfroidure/knifecycle)
 containing the bootstrapped environment and allowing
 to complete and run the process.

[See in context](./src/index.ts#L260-L267)



### 1.3. Server environment

The Whook `prepareEnvironment` function aims to provide the complete
 process environment without effectively planning its run. It allows
 to use that environment for testing or build purposes. It also
 provides a chance to override some services/constants
 before actually preparing the server in actual projects main file.

[See in context](./src/index.ts#L290-L296)



## 2. Services initializers

Whook's embed a few default initializers proxied from
 `common-services`, `@whook/*` or its own `src/services`
 folder. It can be wrapped or overridden, at will, later
 in a project using overrides.

[See in context](./src/index.ts#L307-L312)



### 2.1. Base URL

The `BASE_URL` service is intended to provide a base URL where
 the API can be found at. It can be overridden directly via
 injecting it but it is useful to have a usable URL while
 debugging production environnement.

[See in context](./src/services/BASE_URL.ts#L5-L10)



### 2.2. IP detection

If no `HOST` configuration is specified in dependencies nor in ENV,
 this service detects the machine host automagically.

[See in context](./src/services/HOST.ts#L7-L10)



### 2.3. the `PWD` constant

The Whook server heavily rely on the process working directory
 to dynamically load contents. We are making it available to
 the DI system as a constant.

[See in context](./src/index.ts#L334-L338)



### 2.3. Port detection

If no `PORT` configuration is specified in dependencies nor in ENV,
this service detects a free port automagically.

[See in context](./src/services/PORT.ts#L9-L12)



### 2.4. the `resolve` service

Whook uses the `common-services` `resolve` service to allow
 to easily mock/decorate all ESM resolutions.

[See in context](./src/index.ts#L342-L345)



### 2.5. the `importer` service

Whook uses the `common-services` `importer` service to allow
 to easily mock/decorate all ESM dynamic imports.

[See in context](./src/index.ts#L348-L351)



### 2.6. the `exit` service

Whook uses a built in `exit` service to allow
 to easily mock/decorate the app exit.

[See in context](./src/index.ts#L354-L357)



### 2.6. the `WHOOK_PLUGINS` constant

The Whook `$autoload` service needs to know where to look up
 for things like commands / handlers /services etc...
The `WHOOK_PLUGINS` constant allows you to give the name of
 some modules that embrace the Whook folder structure allowing
 you to just install Whook's plugins to get them automatically
 loaded.

[See in context](./src/index.ts#L376-L383)



### 2.7. the `logger` service

Whook uses a built-in `logger` service to allow
 to easily route the application logs for the 
 `common-services` provided `log` service.

[See in context](./src/index.ts#L360-L364)



#### 2.7.1. Logging

Whook's default logger write to the NodeJS default console
   except for debugging messages where it uses the `debug`
   module so that you can set the `DEBUG` environment
   variable to `whook` and get debug messages in output:
  
  ```sh
  DEBUG=whook npx whook
  ```

[See in context](./src/services/logger.ts#L6-L15)



### 2.8. The `CONFIG` service

Loading the configuration files is done according to the `APP_ENV`
   environment variable. It basically requires a configuration hash
   where the keys are JSON formattable constants.

[See in context](./src/index.ts#L369-L373)



### 2.9. the `$autoload` service

Whook provides a simple way to load the constants, services
 and handlers of a project automatically though several
 strategies. It is done by implementing the `knifecycle`
 auto loading interface.

[See in context](./src/services/_autoload.ts#L63-L68)



#### 2.9.1. the `APP_CONFIG` mapper

First of all the autoloader looks for constants in the
 previously loaded `APP_CONFIG` configurations hash.

[See in context](./src/services/_autoload.ts#L193-L196)



#### 2.9.2. the `API` auto loading

We cannot inject the `API` in the auto loader since
 it is dynamically loaded so doing this during the auto
 loader initialization.

[See in context](./src/services/_autoload.ts#L115-L119)



##### 2.9.2.1. API definitions loader

The `API_DEFINITIONS` service provide a convenient way to
 gather your various API definitions from the handlers you
 created in the `src/handlers` folder.

[See in context](./src/services/API_DEFINITIONS.ts#L27-L31)



##### 2.9.2.2. Typings generator

This command allows you to generate the API types that
 helps you to write your handler in a clean and safe
 manner.

[See in context](./src/commands/generateOpenAPITypes.ts#L11-L16)



##### 2.9.2.3. Open API generator

Here, we reuse the Open API handler to generate the
 definition of the API right inside a CLI command.

[See in context](./src/commands/generateOpenAPISchema.ts#L8-L12)



#### 2.9.3. the `INITIALIZER_PATH_MAP` mapper

The Whook auto-loader allows you to provide the file path
 of a service per its name. It exports a `WhookInitializerMap`
 type to help you ensure yours are valid.

[See in context](./src/services/_autoload.ts#L40-L45)



##### 2.9.3.1. Initializer path mapping

In order to be able to load a service from a given path map
 one can directly specify a path to use for its resolution.

[See in context](./src/services/_autoload.ts#L273-L276)



#### 2.9.4. the `HANDLERS` mapper

Here, we build the handlers map needed by the router by injecting every
 handler required by the API.

[See in context](./src/services/_autoload.ts#L215-L218)



#### 2.9.5. the `WRAPPERS` auto loading

We inject the `HANDLERS_WRAPPERS` in the `WRAPPERS`
 service so that they can be dynamically applied.

[See in context](./src/services/_autoload.ts#L236-L239)



#### 2.9.6. Service/handler/wrapper loading

Finally, we either load the handler/service/wrapper module
 if none of the previous strategies applied.

[See in context](./src/services/_autoload.ts#L267-L270)



##### 2.9.6.1. Plugins resolution

Whook auto loader can look for initializers in a list of
 plugins defined in the `WHOOK_PLUGINS` constant. This
 service checks their existence and computes once for all
 the details needed by the framework (to find services/handlers
 it provides).

[See in context](./src/services/WHOOK_RESOLVED_PLUGINS.ts#L7-L14)



##### 2.9.6.2. Plugins/project paths

Trying to load services from plugins/project paths.

[See in context](./src/services/_autoload.ts#L287-L289)



## 3. the handlers

Handlers are services that provide a definition and implements
 API routes.

[See in context](./src/handlers/getOpenAPI.ts#L13-L16)



### 4.1. Testing

In such a hard life, Whook's make it simple to
 also test your commands.

[See in context](./src/commands/generateOpenAPISchema.test.ts#L6-L10)

