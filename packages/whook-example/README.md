[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# @whook/example
> A basic Whook server

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/whook/blob/main/packages/whook-example/LICENSE)


[//]: # (::contents:start)

This is a basic [Whook](https://github.com/nfroidure/whook) server demonstrating
the various usages of the Whook framework to build REST APIs.

## Usage

To run the server in production:

```sh
npm it
NODE_ENV=production APP_ENV=production npm start
```

You can understand deeply this repository and Whook's internal by simply reading
the [Architecture Notes](./ARCHITECTURE.md). The "See in context" links drive
your directly in the concerned implementation so that you can just see the code
that explains the notes.

Feel free to continue creating architecture notes and to regenerate the markdown
file by running:

```
npm run architecture
```

## Dev

Start the server in development:

```sh
# Simple dev mode
npm run dev

# Watch mode
npm run watch
```

Create a new route / cron / service / provider or command:

```sh
npx whook create
```

Play with the REPL:

```sh
npm run repl
```

Generate the dependency injection graph (here, for the `putTime` handler):

```sh
npm run --silent whook -- __inject putTime,mermaid > DEPENDENCIES.mmd;
docker run --rm -u `id -u`:`id -g` -v $(pwd):/data minlag/mermaid-cli -i DEPENDENCIES.mmd -o DEPENDENCIES.mmd.svg;
```

List available commands:

```sh
## In dev mode
npm run dev -- ls
## With built files
npx whook ls
```

Generate API types:

```sh
npm run apitypes
```

## Debug

Execute a handler in isolation:

```sh
npx whook handler --name putEcho --parameters '{"body": { "echo": "YOLO!" }}'
```

Debug `whook` internals:

```sh
DEBUG=whook npm run dev
```

Debug `knifecycle` internals (dependency injection issues):

```sh
DEBUG=knifecycle npm run dev
```

## Deploying with Google Cloud Functions

Create a project and save its credentials to `.credentials.json`.

Then install Terraform:
```sh
wget https://releases.hashicorp.com/terraform/0.12.24/terraform_0.12.24_linux_amd64.zip
mkdir .bin
unzip -d .bin terraform_0.12.24_linux_amd64.zip
rm terraform_0.12.24_linux_amd64.zip
```

Then initialize the Terraform configuration:
```sh
.bin/terraform init ./terraform;
```

Create a new workspace:
```sh
.bin/terraform workspace new staging
```

Build the functions:
```sh
NODE_ENV=staging npm run build
```

Build the Whook commands Terraform depends on:
```sh
npm run compile
```

Plan the deployment:
```sh
.bin/terraform plan -var="project_id=my-project-1664" \
 -out=terraform.plan terraform
```

Apply changes:
```sh
# parallelism may be necessary to avoid hitting
#  timeouts with a slow connection
.bin/terraform apply -parallelism=1 terraform.plan
```

Finally retrieve the API URL and enjoy!
```sh
.bin/terraform -var="project_id=my-project-1664" \
 output api_url
```

## Testing the GCP Functions

```sh
JWT_SECRET=lol APP_ENV=local npm run dev -- testGCPFunctionRoute \
 --name putEcho --parameters '{ "body": { "echo": "Hey!" } }'
```

[//]: # (::contents:end)

# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/whook/blob/main/packages/whook-example/LICENSE)
