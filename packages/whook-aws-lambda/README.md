[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# @whook/aws-lambda
> Build and deploy to AWS Lambda with Whook.

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/whook/blob/main/packages/whook-aws-lambda/LICENSE)


[//]: # (::contents:start)

This module is aimed to help you to build and deploy your Whook server to
[AWS Lambda](https://aws.amazon.com/en/lambda/).

You can find a complete setup with a Terraform deployment example in
[this pull request](https://github.com/nfroidure/whook/pull/54).

## Quick setup

Install this module:

```sh
npm i @whook/aws-lambda;
```

Add the plugin to the `src/index.ts` main file:

```diff

  // ...

  $.register(
    constant('WHOOK_PLUGINS', [
      ...WHOOK_DEFAULT_PLUGINS,
+      '@whook/aws-lambda',
      '@whook/cors',
    ]),
  );

  // ...
```

Tweak the 2 build functions in your `src/build.ts` main file:

```diff
import {
  // (...)
-  DEFAULT_INITIALIZER_PATH_MAP,
-  runBuild as runBaseBuild,
-  prepareBuildEnvironment as prepareBaseBuildEnvironment,
  // (...)
} from '@whook/whook';
+import {
+  DEFAULT_BUILD_INITIALIZER_PATH_MAP,
+  runBuild as runBaseBuild,
+  prepareBuildEnvironment as prepareBaseBuildEnvironment,
+} from '@whook/aws-lambda';

// (...)

// The `prepareBuildEnvironment` create the build
//  environment
export async function prepareBuildEnvironment(
  $: Knifecycle = new Knifecycle(),
): Promise<Knifecycle> {
  $ = await prepareEnvironment($);

  // (...)

-  // Usually, here you call the installed build env
-  $ = await prepareBaseBuildEnvironment($);
+  // Calling the AWS specific build env
+  $ = await prepareBaseBuildEnvironment($);

  // The build often need to know were initializers
  //  can be found to create a static build and
  //  remove the need to create an injector
  $.register(
    constant('INITIALIZER_PATH_MAP', {
      // (...)
-      ...DEFAULT_INITIALIZER_PATH_MAP,
+      ...DEFAULT_BUILD_INITIALIZER_PATH_MAP,
    }),
  );

  // (...)

}
```

Declare this module types in your `src/whook.d.ts` type definitions:

```diff
import {
+   type WhookCompilerConfig,
   type WhookBaseRouteConfig,
   type WhookBaseCronConfig,
+   type WhookBaseConsumerConfig,
+   type WhookBaseTransformerConfig,
+ } from '@whook/whook';
+ import {
+   type WhookAWSLambdaBuildConfig,
+   type WhookAWSLambdaRouteConfig
+   type WhookAWSLambdaConsumerConfig,
+   type WhookAWSLambdaTransformerConfig,
+ } from '@whook/aws-lambda';

declare module 'application-services' {

  // ...

  export interface AppConfig
-    extends WhookBaseConfigs {}
+    extends WhookBaseConfigs,
+      WhookAWSLambdaBuildConfig,
+      WhookCompilerConfig {}
}

// ...


// ...

declare module '@whook/whook' {
  export interface WhookRouteConfig
    extends WhookBaseRouteConfig,
+      WhookAWSLambdaRouteConfig,
      WhookCORSRouteConfig {}

  export interface WhookCronConfig
-    extends WhookBaseCronConfig {}
+    extends WhookBaseCronConfig,
+      WhookAWSLambdaCronConfig {}
+
+  export interface WhookConsumerConfig
+    extends WhookBaseConsumerConfig,
+      WhookAWSLambdaConsumerConfig {}
+
+  export interface WhookTransformerConfig
+    extends WhookBaseTransformerConfig,
+      WhookAWSLambdaTransformerConfig {}
}

```

And add the AWS Lambda config (usually in `src/config/common/config.js`):

```diff
// ...
import { type AppConfig } from 'application-services';

// ...

const CONFIG: AppConfig = {
  // ...
+  COMPILER_OPTIONS: {
+    externalModules: [],
+    target: '20',
+  },
};

export default CONFIG;
```

# Build

To build your functions:

```sh
# Build all functions
npm run build

# Build only one function
npm run build -- getPing
```

# Debug

You can easily test your functions builds by adding `@whook/aws-lambda` to your
`WHOOK_PLUGINS` list. It provides you some commands like the `testAWSLambdaRoute`
one:

```sh
npx whook testAWSLambdaRoute --name getPing
```

To get more insights when some errors happens:

```sh
DEBUG=whook npm run dev -- testAWSLambdaRoute --name getPing
```

## Deployment

We recommend using [Terraform](https://terraform.io) to deploy your lambda
functions.

There is a complete example on how to deploy your functions
[in this pull request](https://github.com/nfroidure/whook/pull/54).

[//]: # (::contents:end)

# API
## Functions

<dl>
<dt><a href="#initWrapHandlerForConsumerLambda">initWrapHandlerForConsumerLambda(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Wrap an handler to make it work with a consumer AWS Lambda.</p>
</dd>
<dt><a href="#initWrapHandlerForCronLambda">initWrapHandlerForCronLambda(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Wrap an handler to make it work with cron AWS Lambda.</p>
</dd>
<dt><a href="#initWrapHandlerForConsumerLambda">initWrapHandlerForConsumerLambda(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Wrap an handler to make it work with a consumer AWS Lambda.</p>
</dd>
<dt><a href="#initWrapHandlerForKafkaLambda">initWrapHandlerForKafkaLambda(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Wrap an handler to make it work with a kafka AWS Lambda.</p>
</dd>
<dt><a href="#initWrapHandlerForLogSubscriberLambda">initWrapHandlerForLogSubscriberLambda(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Wrap an handler to make it work with a log subscriber AWS Lambda.</p>
</dd>
<dt><a href="#initWrapHandlerForS3Lambda">initWrapHandlerForS3Lambda(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Wrap an handler to make it work with a S3 AWS Lambda.</p>
</dd>
<dt><a href="#initWrapHandlerForConsumerLambda">initWrapHandlerForConsumerLambda(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Wrap an handler to make it work with a transformer AWS Lambda.</p>
</dd>
</dl>

<a name="initWrapHandlerForConsumerLambda"></a>

## initWrapHandlerForConsumerLambda(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Wrap an handler to make it work with a consumer AWS Lambda.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the reshaped env vars.  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services the wrapper depends on |
| services.ENV | <code>Object</code> |  | The process environment |
| services.MAIN_DEFINITION | <code>Object</code> |  | An OpenAPI definitition for that handler |
| services.apm | <code>Object</code> |  | An application monitoring service |
| [services.time] | <code>Object</code> |  | An optional time service |
| [services.log] | <code>Object</code> | <code>noop</code> | An optional logging service |

<a name="initWrapHandlerForCronLambda"></a>

## initWrapHandlerForCronLambda(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Wrap an handler to make it work with cron AWS Lambda.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the reshaped env vars.  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services the wrapper depends on |
| services.ENV | <code>Object</code> |  | The process environment |
| services.MAIN_DEFINITION | <code>Object</code> |  | An OpenAPI definitition for that handler |
| services.apm | <code>Object</code> |  | An application monitoring service |
| [services.time] | <code>Object</code> |  | An optional time service |
| [services.log] | <code>Object</code> | <code>noop</code> | An optional logging service |

<a name="initWrapHandlerForConsumerLambda"></a>

## initWrapHandlerForConsumerLambda(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Wrap an handler to make it work with a consumer AWS Lambda.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the reshaped env vars.  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services the wrapper depends on |
| services.MAIN_DEFINITION | <code>Object</code> |  | An OpenAPI definitition for that handler |
| services.ENV | <code>Object</code> |  | The process environment |
| services.DECODERS | <code>Object</code> |  | Request body decoders available |
| services.ENCODERS | <code>Object</code> |  | Response body encoders available |
| services.PARSED_HEADERS | <code>Object</code> |  | A list of headers that should be parsed as JSON |
| services.PARSERS | <code>Object</code> |  | Request body parsers available |
| services.STRINGIFYERS | <code>Object</code> |  | Response body stringifyers available |
| services.BUFFER_LIMIT | <code>Object</code> |  | The buffer size limit |
| services.apm | <code>Object</code> |  | An application monitoring service |
| services.obfuscator | <code>Object</code> |  | A service to hide sensible values |
| services.errorHandler | <code>Object</code> |  | A service that changes any error to Whook response |
| [services.time] | <code>Object</code> |  | An optional time service |
| [services.log] | <code>Object</code> | <code>noop</code> | An optional logging service |

<a name="initWrapHandlerForKafkaLambda"></a>

## initWrapHandlerForKafkaLambda(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Wrap an handler to make it work with a kafka AWS Lambda.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the reshaped env vars.  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services the wrapper depends on |
| services.ENV | <code>Object</code> |  | The process environment |
| services.MAIN_DEFINITION | <code>Object</code> |  | An OpenAPI definitition for that handler |
| services.apm | <code>Object</code> |  | An application monitoring service |
| [services.time] | <code>Object</code> |  | An optional time service |
| [services.log] | <code>Object</code> | <code>noop</code> | An optional logging service |

<a name="initWrapHandlerForLogSubscriberLambda"></a>

## initWrapHandlerForLogSubscriberLambda(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Wrap an handler to make it work with a log subscriber AWS Lambda.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the reshaped env vars.  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services the wrapper depends on |
| services.ENV | <code>Object</code> |  | The process environment |
| services.MAIN_DEFINITION | <code>Object</code> |  | An OpenAPI definitition for that handler |
| services.apm | <code>Object</code> |  | An application monitoring service |
| [services.time] | <code>Object</code> |  | An optional time service |
| [services.log] | <code>Object</code> | <code>noop</code> | An optional logging service |

<a name="initWrapHandlerForS3Lambda"></a>

## initWrapHandlerForS3Lambda(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Wrap an handler to make it work with a S3 AWS Lambda.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the reshaped env vars.  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services the wrapper depends on |
| services.ENV | <code>Object</code> |  | The process environment |
| services.MAIN_DEFINITION | <code>Object</code> |  | An OpenAPI definitition for that handler |
| services.apm | <code>Object</code> |  | An application monitoring service |
| [services.time] | <code>Object</code> |  | An optional time service |
| [services.log] | <code>Object</code> | <code>noop</code> | An optional logging service |

<a name="initWrapHandlerForConsumerLambda"></a>

## initWrapHandlerForConsumerLambda(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Wrap an handler to make it work with a transformer AWS Lambda.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the reshaped env vars.  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services the wrapper depends on |
| services.ENV | <code>Object</code> |  | The process environment |
| services.MAIN_DEFINITION | <code>Object</code> |  | An OpenAPI definitition for that handler |
| services.apm | <code>Object</code> |  | An application monitoring service |
| [services.time] | <code>Object</code> |  | An optional time service |
| [services.log] | <code>Object</code> | <code>noop</code> | An optional logging service |


# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/whook/blob/main/packages/whook-aws-lambda/LICENSE)
